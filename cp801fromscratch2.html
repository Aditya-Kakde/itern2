<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CP-801 Test Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }

        .sidebar {
            height: 100vh;
            width: 0;
            position: fixed;
            top: 0;
            left: 0;
            background-color: #333;
            overflow-x: hidden;
            transition: 0.3s;
            padding-top: 60px;
            z-index: 1000;
        }
        .sidebar h2 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 20px;
            color: #e9ecef;
        }

        .sidebar a {
            padding: 15px;
            text-decoration: none;
            font-size: 18px;
            color: white;
            display: block;
            transition: 0.2s;
        }

        .sidebar a:hover {
            background-color: #575757;
        }

        .sidebar .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 25px;
            cursor: pointer;
            color: white;
        }

        .content {
            flex-grow: 1;
            padding: 20px;
            margin-left: 50px;
        }

        .menu-btn {
            font-size: 24px;
            cursor: pointer;
            background: none;
            border: none;
            color: white;
            padding: 10px;
            position: fixed;
            top: 15px;
            left: 15px;
            background-color: #007bff;
            border-radius: 5px;
            display: block;
            z-index: 0;
        }

        .container {
            position: relative;
            width: 80%;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }

        .top-right-info {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 14px;
            font-weight: bold;
            color: #333;
            text-align: right;
        }

        h1 {
            text-align: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table, th, td {
            border: 1px solid #ddd;
        }

        th, td {
            padding: 10px;
            text-align: center;
        }

        th {
            background: #007bff;
            color: white;
        }

        .status {
            font-weight: bold;
        }

        .log-container {
            height: 150px;
            overflow-y: auto;
            font-size: 12px;
            text-align: left;
            padding: 5px;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 10px;
        }

        button {
            margin-top: 10px;
            padding: 10px;
            font-size: 16px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }

        .start-btn {
            background: #28a745;
            color: white;
        }

        .pause-btn {
            background: #ffc107;
            color: black;
        }

        .restart-btn {
            background: #17a2b8;
            color: white;
        }

        .stop-btn {
            background: #dc3545;
            color: white;
        }

        .save-btn {
            background: #007bff;
            color: white;
        }

        .upload-btn {
            background: #ffc107;
            color: black;
        }

        .final-upload-btn {
            background: #17a2b8;
            color: white;
            display: none;
        }

        .file-status {
            margin-top: 10px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
            display: none;
        }

        .back-btn {
            float: right;
        }

        .version {
            position: absolute;
            bottom: 20px;
            right: 20px;
            font-size: 14px;
            font-weight: bold;
            color: #333;
            text-align: right;
        }

        .version p {
            margin: 5px 0;
        }
        .pass {
            color: green;
            font-weight: bold;
        }

        .fail {
            color: red;
            font-weight: bold;
        }

        .status-enabled {
            color: #28a745;
        }

        .status-disabled {
            color: #6c757d;
        }

        .status-enabled-continuous {
            color: #17a2b8;
        }

        .status-in-progress {
            color: #ffc107;
        }

        .status-finished {
            color: #03fa1f;
        }

        .status-paused {
            color: #f20909;
        }

        .control-buttons {
            margin-bottom: 15px;
        }
        
        /* New styles for duration controls */
        .duration-control {
            display: inline-block;
            margin-left: 10px;
        }
        .duration-input {
            width: 50px;
            padding: 3px;
            margin-left: 5px;
        }
        .duration-div {
            width: 100px;
            padding: 3px;
            margin-left: 5px;
        }
        .continuous-cell {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .remaining-time {
            font-size: 12px;
            color: #6c757d;
            margin-left: 5px;
        }
        .dropdown-container {
            display: none;
            background-color: #3e5871;
            padding-left: 20px;
        }

        .dropdown-container a {
            padding: 10px 0;
            display: block;
            text-decoration: none;
            color: white;
            font-size: 14px;
        }

        .dropdown-container a:hover {
            text-decoration: underline;
        }
        
        /* New styles for continuous checkbox */
        .continuous-checkbox {
            margin-left: 10px;
        }
        .continuous-label {
            font-size: 14px;
            margin-left: 5px;
        }
        
        /* Duration modal styles */
        .duration-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        
        .duration-modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 350px;
            border-radius: 5px;
        }
        
        .duration-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .duration-modal-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .duration-modal-close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .duration-modal-body {
            margin-bottom: 15px;
        }
        
        .duration-input-group {
            margin-bottom: 15px;
        }
        
        .duration-input-group label {
            display: block;
            margin-bottom: 5px;
        }
        
        .duration-input-wrapper {
            display: flex;
            align-items: center;
        }
        
        .duration-input-wrapper input {
            width: 80px;
            padding: 8px;
            margin-right: 10px;
        }
        
        .duration-input-wrapper select {
            padding: 8px;
        }
        
        .duration-modal-footer {
            display: flex;
            justify-content: flex-end;
        }
        
        .duration-modal-footer button {
            margin-left: 10px;
        }

    </style>
</head>
<body>

<div class="container">
    <h1>CP-801 Test Dashboard</h1>

    <div class="control-buttons">
        <button class="start-btn" onclick="startTests()">Start Test</button>
        <button class="pause-btn" onclick="pauseTests()">Pause Test</button>
        <button class="restart-btn" onclick="restartTests()">Restart Test</button>
        <button class="stop-btn" onclick="stopTests()">Stop Test</button>
        
        <button onclick="window.location.href='ports-v2.html'">Ports</button>
        <button onclick="window.location.href='uart.html'">UART</button>
        
        <button onclick="window.location.href='memory.html'">Memory</button>
        <button onclick="openDurationModal()">Duration</button>
        
        
        
        <button class="back-btn" onclick="window.location.href='index.html'">Back</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>Enable</th>
                <th>Test Name</th>
                <th>Status</th>
                <th>Result</th>
            </tr>
        </thead>
        <tbody id="testTable">
            <tr data-test="Memory">
                <td><input type="checkbox" class="test-toggle" checked onchange="updateTestStatus(this)"></td>
                <td>Memory</td>
                <td class="status status-enabled">Enabled</td>
                <td>-</td>
            </tr>
            <tr data-test="Ethernet">
                <td><input type="checkbox" class="test-toggle" checked onchange="updateTestStatus(this)"></td>
                <td>Ethernet(X1-X2 loopback)</td>
                <td class="status status-enabled">Enabled</td>
                <td>-</td>
            </tr>
            <tr data-test="UART">
                <td><input type="checkbox" class="test-toggle" checked onchange="updateTestStatus(this)"></td>
                <td>UART</td>
                <td class="status status-enabled">Enabled</td>
                <td>-</td>
            </tr>
            <tr data-test="DIO">
                <td><input type="checkbox" class="test-toggle" checked onchange="updateTestStatus(this)"></td>
                <td>DIO</td>
                <td class="status status-enabled">Enabled</td>
                <td>-</td>
            </tr>
            <tr data-test="AI">
                <td><input type="checkbox" class="test-toggle" checked onchange="updateTestStatus(this)"></td>
                <td>AI</td>
                <td class="status status-enabled">Enabled</td>
                <td>-</td>
            </tr>
            <tr data-test="LCD">
                <td><input type="checkbox" class="test-toggle" checked onchange="updateTestStatus(this)"></td>
                <td>LCD</td>
                <td class="status status-enabled">Enabled</td>
                <td>-</td>
            </tr>
            <tr data-test="Keyboard">
                <td><input type="checkbox" class="test-toggle" checked onchange="updateTestStatus(this)"></td>
                <td>Keyboard</td>
                <td class="status status-enabled">Enabled</td>
                <td>-</td>
            </tr>
            <tr data-test="TIL">
                <td><input type="checkbox" class="test-toggle" checked onchange="updateTestStatus(this)"></td>
                <td>TIL</td>
                <td class="status status-enabled">Enabled</td>
                <td>-</td>
            </tr>
            <tr data-test="BLE">
                <td><input type="checkbox" class="test-toggle" checked onchange="updateTestStatus(this)"></td>
                <td>BLE</td>
                <td class="status status-enabled">Enabled</td>
                <td>-</td>
            </tr>
        </tbody>
    </table>
    <p>*minimum 1 minute, maximum 5 days</p>
    
    <h3>Test Logs</h3>
    <div class="log-container" id="globalLog"></div>

    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">Load Parameters</button>
    <input type="file" id="fileInput" style="display: none;" onchange="handleFileUpload()">
    <button class="final-upload-btn" id="finalUploadBtn" onclick="finalUpload()">Final Upload</button>
    <div class="file-status" id="fileStatus">No file uploaded.</div>

    <div class="top-right-info">
        Serial Number: 994356<br>
        Product ID: CABD-9876
    </div>
    <div class="version">Software Version: v1.0.0</div>
</div>

<!-- Duration Modal -->
<div id="durationModal" class="duration-modal">
    <div class="duration-modal-content">
        <div class="duration-modal-header">
            <div class="duration-modal-title">Set Test Duration</div>
            <span class="duration-modal-close" onclick="closeDurationModal()">&times;</span>
        </div>
        <div class="duration-modal-body">
            <div class="duration-input-group">
                <label for="durationValue">Duration:</label>
                <div class="duration-input-wrapper">
                    <input type="number" id="durationValue" min="1" max="7200" value="60">
                    <select id="durationUnit">
                        <option value="minutes">Minutes</option>
                        <option value="hours">Hours</option>
                        <option value="days">Days</option>
                    </select>
                </div>
                <small>Minimum: 1 minute, Maximum: 5 days (7200 minutes)</small>
            </div>
            <input type="checkbox" id="continuousCheckbox" class="continuous-checkbox">
        <label for="continuousCheckbox" class="continuous-label">Run continuously</label>
        </div>
        <div class="duration-modal-footer">
            <button onclick="closeDurationModal()">Cancel</button>
            <button class="save-btn" onclick="saveDuration()">Save</button>
        </div>
    </div>
</div>

<button class="menu-btn" onclick="openNav()">☰</button>

<script>
    // Duration modal functions
    function openDurationModal() {
        document.getElementById('durationModal').style.display = 'block';
    }
    
    function closeDurationModal() {
        document.getElementById('durationModal').style.display = 'none';
    }
    
    function saveDuration() {
        const durationValue = document.getElementById('durationValue').value;
        const durationUnit = document.getElementById('durationUnit').value;
        
        // Validate the input
        const minValue = 1;
        const maxValue = 7200; // 5 days in minutes
        
        if (durationValue < minValue || durationValue > maxValue) {
            alert(`Please enter a value between ${minValue} and ${maxValue} minutes (5 days)`);
            return;
        }
        
        // Convert to minutes for storage
        let durationInMinutes = parseInt(durationValue);
        if (durationUnit === 'hours') {
            durationInMinutes = durationValue * 60;
        } else if (durationUnit === 'days') {
            durationInMinutes = durationValue * 1440; // 24*60
        }
        
        // Store the duration (you can use localStorage or a variable)
        localStorage.setItem('testDuration', durationInMinutes);
        
        // Display the selected duration
        alert(`Test duration set to ${durationValue} ${durationUnit}`);
        
        closeDurationModal();
    }
    
    function saveLogs() {
        const logText = logContainer.innerText;
        const blob = new Blob([logText], { type: 'text/plain' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "test_logs.txt";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        localStorage.removeItem("testLogs");
    }

    function handleFileUpload() {
        const fileInput = document.getElementById("fileInput");
        const fileStatus = document.getElementById("fileStatus");
        const finalUploadBtn = document.getElementById("finalUploadBtn");
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            fileStatus.textContent = `File uploaded: ${file.name}`;
            fileStatus.style.display = "block";
            finalUploadBtn.style.display = "inline-block";
        }
    }

    function finalUpload() {
        alert("Final upload initiated.");
        // Add final upload logic if needed
    }

    function openNav() {
        document.getElementById("mySidebar").style.width = "250px";
    }

    function closeNav() {
        document.getElementById("mySidebar").style.width = "0";
    }
    // Initialize dropdown functionality
    const dropdowns = document.getElementsByClassName("dropdown-btn");
    for (let i = 0; i < dropdowns.length; i++) {
      dropdowns[i].addEventListener("click", function () {
        this.classList.toggle("active");
        const dropdownContent = this.nextElementSibling;
        if (dropdownContent.style.display === "block") {
          dropdownContent.style.display = "none";
        } else {
          dropdownContent.style.display = "block";
        }
      });
    }

</script>
<!--<script>
    const logContainer = document.getElementById('globalLog');
    const testTable = document.getElementById('testTable');
    const testStates = {};  // To track enabled/running/finished states
    const testCounts = {};  // To track pass/fail counts for each test
    let logUpdateInterval = null;
    let globalTestTimeout = null;

    // Initialize all test states and counts when page loads
    function initializeTests() {
        document.querySelectorAll("#testTable tr").forEach(row => {
            const testName = row.getAttribute("data-test");
            
            // Initialize test states
            testStates[testName] = {
                enabled: true,
                running: false,
                finished: false
            };
            
            // Initialize test counts
            testCounts[testName] = { 
                total:0, 
                pass:0, 
                fail:0 
            };
            
            // Initialize display
            updateTestResultDisplay(testName);
        });
    }

    // Call initialization when page loads
    window.addEventListener('DOMContentLoaded', initializeTests);

    function startTests() {
        const rows = testTable.querySelectorAll("tr");
        const isContinuous = document.getElementById("continuousCheckbox").checked;
        
        // Get test duration settings
        let durationInMinutes = localStorage.getItem('testDuration') || 60; // Default to 60 minutes if not set
        durationInMinutes = parseInt(durationInMinutes);
        
        // Clamp between 1 minute and 5 days (7200 minutes) and convert to milliseconds
        const duration = Math.min(Math.max(durationInMinutes, 1), 7200) * 60 * 1000;

        // Set all enabled tests to "In Progress"
        rows.forEach(row => {
            const testName = row.getAttribute("data-test");
            const isEnabled = row.querySelector(".test-toggle").checked;
            
            if (isEnabled) {
                testStates[testName].running = true;
                testStates[testName].finished = false;
                updateTestStatus(row.querySelector(".test-toggle"));
            }
        });

        // Start periodic log updates
        logUpdateInterval = setInterval(fetchAndDisplayLogs, 3000);
        fetchAndDisplayLogs(); // Initial fetch

        // Set timeout to mark tests as finished after duration
        if (!isContinuous) {
            globalTestTimeout = setTimeout(() => {
                rows.forEach(row => {
                    const testName = row.getAttribute("data-test");
                    if (testStates[testName].running) {
                        testStates[testName].running = false;
                        testStates[testName].finished = true;
                        updateTestStatus(row.querySelector(".test-toggle"));
                    }
                });
                logMessage("Test duration completed - all tests marked as finished");
            }, duration);
        }

        logMessage(`All enabled tests started (${isContinuous ? "continuous" : "duration: " + (duration/60000) + " minutes"})`);
    }

    function updateTestStatus(checkbox) {
        const row = checkbox.closest("tr");
        const testName = row.getAttribute("data-test");
        const statusCell = row.querySelector(".status");
        
        const isEnabled = checkbox.checked;
        testStates[testName].enabled = isEnabled;
        
        if (!isEnabled) {
            statusCell.textContent = "Disabled";
            statusCell.className = "status status-disabled";
            testStates[testName].running = false;
            testStates[testName].finished = false;
        } else if (testStates[testName].finished) {
            statusCell.textContent = "Finished";
            statusCell.className = "status status-finished";
        } else if (testStates[testName].running) {
            statusCell.textContent = "In Progress";
            statusCell.className = "status status-in-progress";
        } else {
            statusCell.textContent = "Enabled";
            statusCell.className = "status status-enabled";
        }
    }

    function fetchAndDisplayLogs() {
        fetch('/get-log')
            .then(response => response.json())
            .then(data => {
                logContainer.innerHTML = '';
                let allLogLines = [];
                
                if (Array.isArray(data)) {
                    allLogLines = data;
                } else if (typeof data === 'object') {
                    allLogLines = Object.values(data).flat();
                } else {
                    allLogLines = data.split('\n');
                }
                
                allLogLines.forEach(line => {
                    if (!line) return;
                    
                    const logEntry = document.createElement('div');
                    logEntry.textContent = line;
                    logContainer.appendChild(logEntry);
                    
                    parseTestResults(line);
                });
                
                logContainer.scrollTop = logContainer.scrollHeight;
            })
            .catch(error => {
                console.error('Error fetching logs:', error);
                logMessage(`Error loading logs: ${error.message}`);
            });
    }

    function parseTestResults(line) {
        // Extract test name from log line (e.g., "[MEMORY]" -> "MEMORY")
        const testMatch = line.match(/\[([A-Z]+)\]/);
        if (!testMatch) return;
        
        const testName = testMatch[1];
        const row = document.querySelector(`tr[data-test="${testName}"]`);
        if (!row || !testCounts[testName]) return;

        // Check for test completion
        if (line.includes('Test completed')) {
            testCounts[testName].total++;
            
            if (line.includes('PASS')) {
                testCounts[testName].pass++;
            } else if (line.includes('FAIL')) {
                testCounts[testName].fail++;
            }
            
            updateTestResultDisplay(testName);
        }
        // Special handling for Ethernet packet counts
        else if (testName === 'ETHERNET' && line.includes('packets sent')) {
            testCounts[testName].total++;
            if (line.includes('1000/1000')) {
                testCounts[testName].pass++;
            } else {
                testCounts[testName].fail++;
            }
            updateTestResultDisplay(testName);
        }
    }

    function updateTestResultDisplay(testName) {
        const row = document.querySelector(`tr[data-test="${testName}"]`);
        if (!row || !testCounts[testName]) return;

        const counts = testCounts[testName];
        const resultCell = row.cells[3];
        
        resultCell.innerHTML = `
            Total: ${counts.total}<br>
            <span class="pass">Pass: ${counts.pass}</span><br>
            <span class="fail">Fail: ${counts.fail}</span>
        `;
    }

    function logMessage(message) {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.innerHTML = `[${timestamp}] ${message}`;
        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;
    }

    // Initialize test toggles
    document.querySelectorAll(".test-toggle").forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateTestStatus(this);
        });
    });

    // Initialize continuous checkbox
    document.getElementById("continuousCheckbox").addEventListener("change", function() {
        const rows = testTable.querySelectorAll("tr");
        rows.forEach(row => {
            const checkbox = row.querySelector(".test-toggle");
            if (checkbox.checked) {
                updateTestStatus(checkbox);
            }
        });
    });

    function openReconfig() {
      document.getElementById("modalOverlay").style.display = "block";
      document.getElementById("configModal").style.display = "block";
    }
</script>-->
<script>
    const logContainer = document.getElementById('globalLog');
    const testTable = document.getElementById('testTable');
    const testStates = {};  // To track enabled/running/finished states
    const latestTestResults = {}; // To track latest pass/fail counts for each test
    let logUpdateInterval = null;
    let globalTestTimeout = null;

    // Initialize all test states when page loads
    function initializeTests() {
        document.querySelectorAll("#testTable tr").forEach(row => {
            const testName = row.getAttribute("data-test");
            
            // Initialize test states
            testStates[testName] = {
                enabled: true,
                running: false,
                finished: false
            };
            
            // Initialize test results
            latestTestResults[testName] = {
                pass: 0,
                fail: 0
            };
            
            // Initialize display
            updateTestResultDisplay(testName);
        });
    }

    // Call initialization when page loads
    window.addEventListener('DOMContentLoaded', initializeTests);

    function startTests() {
        const rows = testTable.querySelectorAll("tr");
        const isContinuous = document.getElementById("continuousCheckbox").checked;
        
        // Get test duration settings
        let durationInMinutes = localStorage.getItem('testDuration') || 60;
        durationInMinutes = parseInt(durationInMinutes);
        
        // Clamp between 1 minute and 5 days (7200 minutes) and convert to milliseconds
        const duration = Math.min(Math.max(durationInMinutes, 1), 7200) * 60 * 1000;

        // Set all enabled tests to "In Progress"
        rows.forEach(row => {
            const testName = row.getAttribute("data-test");
            const isEnabled = row.querySelector(".test-toggle").checked;
            
            if (isEnabled) {
                testStates[testName].running = true;
                testStates[testName].finished = false;
                updateTestStatus(row.querySelector(".test-toggle"));
            }
        });

        // Start periodic log updates
        logUpdateInterval = setInterval(fetchAndDisplayLogs, 3000);
        fetchAndDisplayLogs(); // Initial fetch

        // Set timeout to mark tests as finished after duration
        if (!isContinuous) {
            globalTestTimeout = setTimeout(() => {
                rows.forEach(row => {
                    const testName = row.getAttribute("data-test");
                    if (testStates[testName].running) {
                        testStates[testName].running = false;
                        testStates[testName].finished = true;
                        updateTestStatus(row.querySelector(".test-toggle"));
                    }
                });
                logMessage("Test duration completed - all tests marked as finished");
            }, duration);
        }

        logMessage(`All enabled tests started (${isContinuous ? "continuous" : "duration: " + (duration/60000) + " minutes"})`);
    }

    function updateTestStatus(checkbox) {
        const row = checkbox.closest("tr");
        const testName = row.getAttribute("data-test");
        const statusCell = row.querySelector(".status");
        
        const isEnabled = checkbox.checked;
        testStates[testName].enabled = isEnabled;
        
        if (!isEnabled) {
            statusCell.textContent = "Disabled";
            statusCell.className = "status status-disabled";
            testStates[testName].running = false;
            testStates[testName].finished = false;
        } else if (testStates[testName].finished) {
            statusCell.textContent = "Finished";
            statusCell.className = "status status-finished";
        } else if (testStates[testName].running) {
            statusCell.textContent = "In Progress";
            statusCell.className = "status status-in-progress";
        } else {
            statusCell.textContent = "Enabled";
            statusCell.className = "status status-enabled";
        }
    }

    function fetchAndDisplayLogs() {
        fetch('/get-log')
            .then(response => response.json())
            .then(data => {
                logContainer.innerHTML = '';
                let allLogLines = [];
                
                if (Array.isArray(data)) {
                    allLogLines = data;
                } else if (typeof data === 'object') {
                    allLogLines = Object.values(data).flat();
                } else {
                    allLogLines = data.split('\n');
                }
                
                // Process logs in reverse to find the latest results first
                for (let i = allLogLines.length - 1; i >= 0; i--) {
                    const line = allLogLines[i];
                    if (!line) continue;
                    
                    // Display all logs
                    const logEntry = document.createElement('div');
                    logEntry.textContent = line;
                    logContainer.appendChild(logEntry);
                    
                    // Parse for test results (only process if we haven't found latest results yet)
                    parseTestResults(line);
                }
                
                logContainer.scrollTop = logContainer.scrollHeight;
            })
            .catch(error => {
                //console.error('Error fetching logs:', error);
                //logMessage(`Error loading logs: ${error.message}`);
            });
    }

    function parseTestResults(line) {
        // Extract test name from log line (e.g., "[MEMORY]" -> "MEMORY")
        const testMatch = line.match(/\[([A-Z]+)\]/);
        if (!testMatch) return;
        
        const testName = testMatch[1];
        
        // Only process if we haven't found results for this test yet
        if (latestTestResults[testName].processed) return;
        
        // Check for PASS/FAIL in this line
        const passMatch = line.match(/PASS-(\d+)/);
        const failMatch = line.match(/FAIL-(\d+)/);
        
        if (passMatch || failMatch) {
            // Update counts based on what we found
            if (passMatch) {
                latestTestResults[testName].pass = parseInt(passMatch[1]);
            }
            if (failMatch) {
                latestTestResults[testName].fail = parseInt(failMatch[1]);
            }
            
            // Mark this test as processed so we don't look at older entries
            latestTestResults[testName].processed = true;
            
            // Update the display
            updateTestResultDisplay(testName);
        }
    }

    function updateTestResultDisplay(testName) {
        const row = document.querySelector(`tr[data-test="${testName}"]`);
        if (!row) return;

        const resultCell = row.cells[3];
        const results = latestTestResults[testName];
        const total = results.pass + results.fail;
        
        resultCell.innerHTML = `
            Total: ${total}<br>
            <span class="pass">Pass: ${results.pass}</span><br>
            <span class="fail">Fail: ${results.fail}</span>
        `;
    }

    function logMessage(message) {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.innerHTML = `[${timestamp}] ${message}`;
        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;
    }

    // Initialize test toggles
    document.querySelectorAll(".test-toggle").forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateTestStatus(this);
        });
    });

    // Initialize continuous checkbox
    document.getElementById("continuousCheckbox").addEventListener("change", function() {
        const rows = testTable.querySelectorAll("tr");
        rows.forEach(row => {
            const checkbox = row.querySelector(".test-toggle");
            if (checkbox.checked) {
                updateTestStatus(checkbox);
            }
        });
    });
</script>
</html>